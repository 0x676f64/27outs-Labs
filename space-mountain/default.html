<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diamond Analytics - MLB Platform</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, sans-serif; transition: background-color 0.3s ease; }
    body.light { background-color: #f7fafc; color: #1e293b; }
    body.dark { background-color: #0a0e1a; color: #e2e8f0; }
    nav { border-bottom: 1px solid; transition: all 0.3s ease; }
    body.light nav { background-color: #ffffff; border-color: #e2e8f0; }
    body.dark nav { background-color: #151b2e; border-color: #1e293b; }
    .nav-container { max-width: 1400px; margin: 0 auto; padding: 0 80px; display: flex; justify-content: space-between; align-items: center; height: 60px; }
    .logo { font-size: 15px; font-weight: 700; letter-spacing: -0.02em; height: 40px; display: flex; align-items: center; }
    .logo img { height: 100%; width: auto; }
    #logoImg { height: 3rem; }
    .nav-links { display: flex; gap: 32px; align-items: center; }
    .nav-links a { font-size: 13px; font-weight: 500; text-decoration: none; transition: opacity 0.2s; }
    body.light .nav-links a { color: #1e293b; }
    body.dark .nav-links a { color: #e2e8f0; }
    .nav-links a:hover { opacity: 0.7; }
    .theme-toggle { background: transparent; border: 1px solid; padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    body.light .theme-toggle { border-color: #e2e8f0; color: #1e293b; }
    body.dark .theme-toggle { border-color: #1e293b; color: #e2e8f0; }
    .main-content { max-width: 1400px; margin: 0 auto; padding: 40px 80px; }
    .header { margin-bottom: 32px; }
    .header h1 { font-size: 28px; font-weight: 700; margin: 0 0 8px 0; letter-spacing: -0.03em; }
    .header p { font-size: 13px; margin: 0; font-weight: 400; }
    body.light .header p { color: #64748b; }
    body.dark .header p { color: #94a3b8; }
    .games-section { display: flex; gap: 16px; margin-bottom: 24px; }
    .date-picker-button { border-radius: 6px; padding: 12px 16px; border: 1px solid; width: 180px; flex-shrink: 0; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: space-between; transition: all 0.2s; position: relative; }
    body.light .date-picker-button { background-color: #ffffff; border-color: #e2e8f0; color: #1e293b; }
    body.dark .date-picker-button { background-color: #151b2e; border-color: #1e293b; color: #e2e8f0; }
    .date-picker-button:hover { border-color: #bf0d3d; }
    .date-picker-button::after { content: '▼'; font-size: 10px; opacity: 0.6; }
    .calendar-dropdown { position: absolute; top: 60px; left: 0; z-index: 100; border-radius: 6px; padding: 16px; border: 1px solid; width: 280px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); display: none; }
    .calendar-dropdown.open { display: block; }
    body.light .calendar-dropdown { background-color: #ffffff; border-color: #e2e8f0; }
    body.dark .calendar-dropdown { background-color: #151b2e; border-color: #1e293b; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4); }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .calendar-month { font-size: 13px; font-weight: 600; }
    .calendar-nav { background: transparent; border: none; font-size: 16px; cursor: pointer; padding: 4px 8px; }
    body.light .calendar-nav { color: #1e293b; }
    body.dark .calendar-nav { color: #e2e8f0; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .calendar-day-label { font-size: 10px; font-weight: 600; text-align: center; padding: 6px 0; }
    body.light .calendar-day-label { color: #64748b; }
    body.dark .calendar-day-label { color: #94a3b8; }
    .calendar-day { font-size: 11px; text-align: center; padding: 8px 0; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
    body.light .calendar-day { color: #1e293b; }
    body.dark .calendar-day { color: #e2e8f0; }
    .calendar-day:hover { background-color: rgba(191, 13, 61, 0.1); }
    .calendar-day.selected { background-color: #bf0d3d; color: white; font-weight: 600; }
    .calendar-day.empty { cursor: default; }
    .calendar-day.empty:hover { background-color: transparent; }
    .games-slider-container { flex: 1; position: relative; overflow: hidden; }
    .games-slider { display: flex; gap: 16px; transition: transform 0.3s ease; }
    .game-box { min-width: calc(25% - 12px); border-radius: 6px; padding: 16px; border: 1px solid; flex-shrink: 0; cursor: pointer; transition: all 0.2s ease; }
    body.light .game-box { background-color: #ffffff; border-color: #e2e8f0; }
    body.dark .game-box { background-color: #151b2e; border-color: #1e293b; }
    .game-box:hover { transform: scale(1.03); box-shadow: 0 6px 20px rgba(191, 13, 61, 0.2); border-color: rgba(191, 13, 61, 0.4); }
    .game-status { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px; }
    body.light .game-status { color: #64748b; }
    body.dark .game-status { color: #94a3b8; }
    .game-status.live { color: #bf0d3d; }
    .game-matchup { display: flex; flex-direction: column; gap: 8px; }
    .team-row { display: flex; justify-content: space-between; align-items: center; }
    .team-logo { width: 28px; height: 28px; margin-right: 8px; }
    .team-name { font-size: 13px; font-weight: 600; display: flex; align-items: center; flex: 1; }
    .team-score { font-size: 18px; font-weight: 700; }
    body.light .team-name, body.light .team-score { color: #041e41; }
    body.dark .team-name, body.dark .team-score { color: #b9b9bb; }
    .slider-arrow { position: absolute; right: 0; top: 50%; transform: translateY(-50%); background: transparent; border: 1px solid; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.2s; z-index: 10; }
    body.light .slider-arrow { border-color: #e2e8f0; color: #1e293b; background-color: #ffffff; }
    body.dark .slider-arrow { border-color: #1e293b; color: #e2e8f0; background-color: #151b2e; }
    .slider-arrow:hover { background-color: #bf0d3d; border-color: #bf0d3d; color: white; }
    .slider-arrow.left { left: 0; right: auto; }
    .no-games { text-align: center; padding: 40px 20px; font-size: 14px; font-weight: 500; }
    body.light .no-games { color: #64748b; }
    body.dark .no-games { color: #94a3b8; }
    .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
    .info-card { border-radius: 6px; padding: 20px; border: 1px solid; }
    body.light .info-card { background-color: #ffffff; border-color: #e2e8f0; }
    body.dark .info-card { background-color: #151b2e; border-color: #1e293b; }
    .info-header { margin-bottom: 16px; }
    .info-title { font-size: 14px; font-weight: 600; margin-bottom: 20px; margin: 0 auto; text-align: center; }
    .league-tabs { display: flex; gap: 8px; margin-bottom: 12px; justify-content: center; }
    .league-tab { background: transparent; border: 1px solid; padding: 6px 16px; border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    body.light .league-tab { border-color: #e2e8f0; color: #64748b; }
    body.dark .league-tab { border-color: #1e293b; color: #94a3b8; }
    .league-tab.active { background-color: #bf0d3d; border-color: #bf0d3d; color: white; }
    .standings-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; max-height: 400px; overflow-y: auto; }
    .division-column { border-radius: 6px; padding: 8px; border: 1px solid; }
    body.light .division-column { background-color: #ffffff; border-color: #e2e8f0; }
    body.dark .division-column { background-color: #151b2e; border-color: #1e293b; }
    .division-title { font-size: 12px; font-weight: 700; margin-bottom: 8px; text-align: center; }
    .division-list { display: flex; flex-direction: column; gap: 6px; }
    .standing-row { display: flex; align-items: center; gap: 8px; font-size: 11px; padding: 4px 0; }
    .standing-logo { width: 20px; height: 20px; flex-shrink: 0; }
    .standing-record { font-weight: 600; min-width: 50px; }
    .standing-gb { font-weight: 500; min-width: 30px; }
    body.light .standing-gb { color: #64748b; }
    body.dark .standing-gb { color: #94a3b8; }
    .player-list { display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto; }
    .player-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 4px; transition: all 0.2s; }
    body.light .player-item { background-color: #f7fafc; }
    body.dark .player-item { background-color: #0a0e1a; }
    .rating-badge { border-radius: 0.1875rem; flex: 0 0 auto; margin: 0 0.3rem 0 0; width: 0.75rem; height: 0.75rem; z-index: 1; }
    .player-info { flex: 1; }
    .player-item-name { font-size: 12px; font-weight: 600; margin-bottom: 2px; }
    .player-item-team { font-size: 10px; font-weight: 500; }
    body.light .player-item-team { color: #64748b; }
    body.dark .player-item-team { color: #94a3b8; }
    .player-rating { font-size: 14px; font-weight: 700; }
    .prediction-list { display: flex; flex-direction: column; gap: 12px; }
    .prediction-row { display: flex; align-items: center; gap: 10px; }
    .prediction-logo { width: 24px; height: 24px; flex-shrink: 0; }
    .prediction-bar-container { flex: 1; height: 20px; border-radius: 4px; overflow: hidden; position: relative; }
    body.light .prediction-bar-container { background-color: #f1f5f9; }
    body.dark .prediction-bar-container { background-color: #0a0e1a; }
    .prediction-bar { height: 100%; background-color: #bf0d3d; transition: width 0.5s ease; }
    .prediction-percentage { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 11px; font-weight: 600; }
    body.light .prediction-percentage { color: #1e293b; }
    body.dark .prediction-percentage { color: #e2e8f0; }
    .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
    .chart-card { border-radius: 6px; padding: 20px; border: 1px solid; }
    body.light .chart-card { background-color: #ffffff; border-color: #e2e8f0; }
    body.dark .chart-card { background-color: #151b2e; border-color: #1e293b; }
    .chart-header { margin-bottom: 16px; }
    .chart-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
    .chart-subtitle { font-size: 11px; font-weight: 500; }
    body.light .chart-subtitle { color: #64748b; }
    body.dark .chart-subtitle { color: #94a3b8; }
    .metrics-card { border-radius: 6px; padding: 20px; border: 1px solid; }
    body.light .metrics-card { background-color: #ffffff; border-color: #e2e8f0; }
    body.dark .metrics-card { background-color: #151b2e; border-color: #1e293b; }
    .metrics-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; }
    .metric-item { font-size: 11px; }
    .metric-label { margin-bottom: 6px; font-weight: 500; }
    body.light .metric-label { color: #64748b; }
    body.dark .metric-label { color: #94a3b8; }
    .metric-value { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
    .metric-change { font-size: 11px; font-weight: 600; }
    .metric-change.positive { color: #10b981; }
    .metric-change.negative { color: #ef4444; }
    canvas { max-height: 200px; }
    .loading { text-align: center; padding: 20px; font-size: 13px; color: #64748b; }
  </style>
</head>
<body class="light">
  <nav>
    <div class="nav-container">
      <div class="logo">
      <a href="default.html">
        <img id="logoImg" src="assets/site-logos/logo-dark.svg" alt="Diamond Analytics">
      </a>
      </div>
      <div class="nav-links">
        <a href="#">Players</a>
        <a href="#">Teams</a>
        <a href="#">Gamefeed</a>
        <a href="#">Predictions</a>
        <a href="#">Metrics</a>
        <a href="#">Research</a>
        <button class="theme-toggle" id="themeToggle">Dark</button>
      </div>
    </div>
  </nav>

  <div class="main-content">
    <div class="header">
      <h1>Performance Dashboard</h1>
      <p>Advanced metrics and predictive analytics for the 2026 season</p>
    </div>

    <div class="games-section">
      <div style="position: relative;">
        <div class="date-picker-button" id="datePickerBtn">
          <span id="selectedDateText">Today</span>
        </div>
        <div class="calendar-dropdown" id="calendarDropdown">
          <div class="calendar-header">
            <button class="calendar-nav" id="prevMonth">‹</button>
            <div class="calendar-month" id="calendarMonth"></div>
            <button class="calendar-nav" id="nextMonth">›</button>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
        </div>
      </div>

      <div class="games-slider-container">
        <button class="slider-arrow left" id="prevGames" style="display: none;">‹</button>
        <div class="games-slider" id="gamesSlider">
          <div class="loading">Loading games...</div>
        </div>
        <button class="slider-arrow" id="nextGames" style="display: none;">›</button>
      </div>
    </div>

    <div class="info-grid">
      <div class="info-card">
        <div class="info-header">
          <div class="info-title">Standings</div>
          <div class="league-tabs">
            <button class="league-tab active" id="alTab">AL</button>
            <button class="league-tab" id="nlTab">NL</button>
          </div>
        </div>
        <div class="standings-list" id="standingsList">
          <div class="loading">Loading standings...</div>
        </div>
      </div>

      <div class="info-card">
        <div class="info-header">
          <div class="info-title">Top Performers</div>
        </div>
        <div class="player-list" id="topPerformersList"></div>
      </div>

      <div class="info-card">
        <div class="info-header">
          <div class="info-title">2026 World Series Prediction</div>
        </div>
        <div class="prediction-list" id="predictionList"></div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Performance Trends</div>
          <div class="chart-subtitle">Monthly OPS and wOBA progression</div>
        </div>
        <canvas id="performanceChart"></canvas>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">wAR Projection Model</div>
          <div class="chart-subtitle">Historical vs. projected performance</div>
        </div>
        <canvas id="projectionChart"></canvas>
      </div>
    </div>

    <div class="metrics-card">
      <div class="chart-header">
        <div class="chart-title">Advanced Metrics Breakdown</div>
        <div class="chart-subtitle">Comprehensive statistical analysis</div>
      </div>
      <div class="metrics-grid" id="metricsGrid"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <script>
    const topPerformers = [
      { name: 'Shohei Ohtani', team: 'LAD', rating: 98 },
      { name: 'Aaron Judge', team: 'NYY', rating: 95 },
      { name: 'Mookie Betts', team: 'LAD', rating: 93 },
      { name: 'Bobby Witt Jr.', team: 'KC', rating: 87 },
      { name: 'Bryce Harper', team: 'PHI', rating: 85 }
    ];

    const wsPredictions = [
      { teamId: 119, percentage: 28 },
      { teamId: 147, percentage: 22 },
      { teamId: 144, percentage: 18 },
      { teamId: 117, percentage: 15 }
    ];

    let currentLeague = 'AL';
    let standingsData = { AL: { East: [], Central: [], West: [] }, NL: { East: [], Central: [], West: [] } };

    function getRatingColor(rating) {
      if (rating >= 88) return '#3b82f6';
      if (rating >= 76) return '#14b8a6';
      if (rating >= 66) return '#22c55e';
      if (rating >= 56) return '#eab308';
      if (rating >= 46) return '#fb923c';
      if (rating >= 31) return '#f97316';
      return '#ef4444';
    }

    function getDivisionInfo(divisionId) {
      switch (divisionId) {
        case 201: return { league: 'AL', division: 'East' };
        case 202: return { league: 'AL', division: 'Central' };
        case 200: return { league: 'AL', division: 'West' };
        case 204: return { league: 'NL', division: 'East' };
        case 205: return { league: 'NL', division: 'Central' };
        case 203: return { league: 'NL', division: 'West' };
        default: return { league: 'AL', division: 'East' };
      }
    }

    async function fetchStandings() {
      try {
        const response = await fetch('https://statsapi.mlb.com/api/v1/standings?leagueId=103,104&season=2025&standingsTypes=regularSeason');
        const data = await response.json();

        // reset divisions
        standingsData.AL = { East: [], Central: [], West: [] };
        standingsData.NL = { East: [], Central: [], West: [] };

        data.records.forEach(division => {
          // Get division ID and map to league/division
          const divisionId = division.division ? division.division.id : null;
          if (!divisionId) return;

          const { league, division: divKey } = getDivisionInfo(divisionId);

          // Add teams to the correct league and division
          (division.teamRecords || []).forEach(team => {
            standingsData[league][divKey].push({
              teamId: team.team.id,
              wins: team.wins,
              losses: team.losses,
              gamesBack: team.gamesBack,
              divisionRank: team.divisionRank
            });
          });
        });

        // sort each division by division rank
        ['East', 'Central', 'West'].forEach(d => {
          standingsData.AL[d].sort((a, b) => a.divisionRank - b.divisionRank);
          standingsData.NL[d].sort((a, b) => a.divisionRank - b.divisionRank);
        });

        renderStandings();
      } catch (error) {
        console.error('fetchStandings error', error);
        document.getElementById('standingsList').innerHTML = '<div class="loading">Failed to load standings</div>';
      }
    }

    function renderStandings() {
      const list = document.getElementById('standingsList');
      const leagueData = standingsData[currentLeague];
      const isDark = document.body.classList.contains('dark');

      if (!leagueData) {
        list.innerHTML = '<div class="loading">No standings available</div>';
        return;
      }

      const divOrder = ['East', 'Central', 'West'];
      list.innerHTML = divOrder.map(div => {
        const teams = leagueData[div] || [];
        const rows = teams.map(team => {
          const logoUrl = isDark 
            ? `https://www.mlbstatic.com/team-logos/team-cap-on-dark/${team.teamId}.svg`
            : `https://www.mlbstatic.com/team-logos/${team.teamId}.svg`;
          const gb = team.gamesBack === '0.0' ? '-' : team.gamesBack;
          return `
            <div class="standing-row">
              <img src="${logoUrl}" alt="Team" class="standing-logo">
              <div class="standing-record">${team.wins}-${team.losses}</div>
              <div class="standing-gb">${gb}</div>
            </div>
          `;
        }).join('');

        return `
          <div class="division-column">
            <div class="division-title">${currentLeague} ${div}</div>
            <div class="division-list">${rows || '<div class="loading">No teams</div>'}</div>
          </div>
        `;
      }).join('');
    }

    function renderTopPerformers() {
      const list = document.getElementById('topPerformersList');
      list.innerHTML = topPerformers.map(player => `
        <div class="player-item">
          <div class="rating-badge" style="background-color: ${getRatingColor(player.rating)}"></div>
          <div class="player-info">
            <div class="player-item-name">${player.name}</div>
            <div class="player-item-team">${player.team}</div>
          </div>
          <div class="player-rating">${player.rating}</div>
        </div>
      `).join('');
    }

    async function renderPredictions() {
      const list = document.getElementById('predictionList');
      const isDark = document.body.classList.contains('dark');

      const predictionsHtml = wsPredictions.map(pred => {
        const logoUrl = isDark
          ? `https://www.mlbstatic.com/team-logos/team-cap-on-dark/${pred.teamId}.svg`
          : `https://www.mlbstatic.com/team-logos/${pred.teamId}.svg`;
        
        return `
          <div class="prediction-row">
            <img src="${logoUrl}" alt="Team" class="prediction-logo">
            <div class="prediction-bar-container">
              <div class="prediction-bar" style="width: ${pred.percentage}%"></div>
              <div class="prediction-percentage">${pred.percentage}%</div>
            </div>
          </div>
        `;
      }).join('');

      list.innerHTML = predictionsHtml;
    }

    document.getElementById('alTab').addEventListener('click', () => {
      currentLeague = 'AL';
      document.getElementById('alTab').classList.add('active');
      document.getElementById('nlTab').classList.remove('active');
      renderStandings();
    });

    document.getElementById('nlTab').addEventListener('click', () => {
      currentLeague = 'NL';
      document.getElementById('nlTab').classList.add('active');
      document.getElementById('alTab').classList.remove('active');
      renderStandings();
    });

    let cDate = new Date();
    let cSlide = 0;

    function fDate(d) {
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    }

    function fTime(gd) {
      return new Date(gd).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });
    }

    async function fAbbr(tid) {
      try {
        const r = await fetch(`https://statsapi.mlb.com/api/v1/teams/${tid}`);
        const d = await r.json();
        return d.teams[0].abbreviation || "N/A";
      } catch { return "N/A"; }
    }

    async function fDetails(gpk) {
      try {
        const r = await fetch(`https://statsapi.mlb.com/api/v1.1/game/${gpk}/feed/live`);
        const d = await r.json();
        if (d?.liveData) {
          const ls = d.liveData.linescore;
          const ih = ls.inningHalf ? (ls.inningHalf === "Top" ? "TOP" : "BOT") : "";
          const ci = ls.currentInning || "";
          return `${ih} ${ci}`;
        }
      } catch {}
      return "In Progress";
    }

    function rCal() {
      const g = document.getElementById('calendarGrid');
      const m = document.getElementById('calendarMonth');
      const y = cDate.getFullYear();
      const mo = cDate.getMonth();
      m.textContent = cDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      const fd = new Date(y, mo, 1).getDay();
      const dim = new Date(y, mo + 1, 0).getDate();
      const dl = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
      let h = dl.map(d => `<div class="calendar-day-label">${d}</div>`).join('');
      for (let i = 0; i < fd; i++) h += '<div class="calendar-day empty"></div>';
      const sd = cDate.getDate();
      for (let day = 1; day <= dim; day++) {
        h += `<div class="calendar-day ${day === sd ? 'selected' : ''}" data-day="${day}">${day}</div>`;
      }
      g.innerHTML = h;
      g.querySelectorAll('.calendar-day:not(.empty)').forEach(el => {
        el.addEventListener('click', (e) => {
          cDate.setDate(parseInt(e.target.dataset.day));
          uDateText();
          rCal();
          fGames();
          document.getElementById('calendarDropdown').classList.remove('open');
        });
      });
    }

    function uDateText() {
      const t = document.getElementById('selectedDateText');
      const today = new Date();
      const isTdy = cDate.toDateString() === today.toDateString();
      if (isTdy) {
        t.textContent = 'Today';
      } else {
        t.textContent = cDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }
    }

    document.getElementById('datePickerBtn').addEventListener('click', () => {
      document.getElementById('calendarDropdown').classList.toggle('open');
    });

    document.addEventListener('click', (e) => {
      const dp = document.getElementById('datePickerBtn');
      const cd = document.getElementById('calendarDropdown');
      if (!dp.contains(e.target) && !cd.contains(e.target)) {
        cd.classList.remove('open');
      }
    });

    document.getElementById('prevMonth').addEventListener('click', () => { cDate.setMonth(cDate.getMonth() - 1); uDateText(); rCal(); fGames(); });
    document.getElementById('nextMonth').addEventListener('click', () => { cDate.setMonth(cDate.getMonth() + 1); uDateText(); rCal(); fGames(); });

    async function fGames() {
      const s = document.getElementById('gamesSlider');
      const sd = fDate(cDate);
      const url = `https://statsapi.mlb.com/api/v1/schedule?sportId=1&date=${sd}`;
      s.innerHTML = '<div class="loading">Loading games...</div>';
      cSlide = 0;
      try {
        const r = await fetch(url);
        const d = await r.json();
        if (!d.dates.length || !d.dates[0].games.length) {
          s.innerHTML = '<div class="game-box"><div class="no-games">No Games Today</div></div>';
          document.getElementById('prevGames').style.display = 'none';
          document.getElementById('nextGames').style.display = 'none';
          return;
        }
        const gbs = await Promise.all(d.dates[0].games.map(async (g) => {
          const hid = g.teams.home.team.id;
          const aid = g.teams.away.team.id;
          const hs = g.teams.home.score || 0;
          const as = g.teams.away.score || 0;
          let st = g.status.detailedState;
          const ha = await fAbbr(hid);
          const aa = await fAbbr(aid);
          if (st === "Final" || st === "Game Over" || st === "Completed Early") st = "FINAL";
          else if (st === "Pre-Game" || st === "Scheduled") st = fTime(g.gameDate);
          else if (st === "In Progress") st = await fDetails(g.gamePk);
          const dm = document.body.classList.contains("dark");
          const hl = dm ? `https://www.mlbstatic.com/team-logos/team-cap-on-dark/${hid}.svg` : `https://www.mlbstatic.com/team-logos/${hid}.svg`;
          const al = dm ? `https://www.mlbstatic.com/team-logos/team-cap-on-dark/${aid}.svg` : `https://www.mlbstatic.com/team-logos/${aid}.svg`;
          const gb = document.createElement('div');
          gb.className = 'game-box';
          gb.style.cursor = 'pointer';
          gb.innerHTML = `<div class="game-status ${st.includes('TOP') || st.includes('BOT') ? 'live' : ''}">${st}</div><div class="game-matchup"><div class="team-row"><div class="team-name"><img src="${al}" alt="${aa}" class="team-logo">${aa}</div><div class="team-score">${as}</div></div><div class="team-row"><div class="team-name"><img src="${hl}" alt="${ha}" class="team-logo">${ha}</div><div class="team-score">${hs}</div></div></div>`;
          
          // Add click handler to navigate to game-box.html with game data
         gb.addEventListener('click', () => {
        const gameData = {
          gamePk: g.gamePk,
          homeTeam: { id: hid, abbr: ha, score: hs },
          awayTeam: { id: aid, abbr: aa, score: as },
          status: st,
          gameDate: g.gameDate
        };

        sessionStorage.setItem('selectedGame', JSON.stringify(gameData));

        window.location.href = `game-box.html?gamePk=${g.gamePk}`;
      });

          
          return { gameBox: gb, gameStatus: st, gameDate: new Date(g.gameDate) };
        }));
        gbs.sort((a, b) => {
          if (a.gameStatus.includes("TOP") || a.gameStatus.includes("BOT")) return -1;
          if (b.gameStatus.includes("TOP") || b.gameStatus.includes("BOT")) return 1;
          if (a.gameStatus === "FINAL" && b.gameStatus !== "FINAL") return 1;
          if (b.gameStatus === "FINAL" && a.gameStatus !== "FINAL") return -1;
          return a.gameDate - b.gameDate;
        });
        s.innerHTML = '';
        gbs.forEach(({ gameBox }) => s.appendChild(gameBox));
        const sa = gbs.length > 4;
        document.getElementById('prevGames').style.display = 'none';
        document.getElementById('nextGames').style.display = sa ? 'flex' : 'none';
      } catch { s.innerHTML = '<div class="game-box"><div class="no-games">Failed to load games</div></div>'; }
    }

    function uSlide() {
      const s = document.getElementById('gamesSlider');
      const sw = s.querySelector('.game-box')?.offsetWidth || 0;
      const o = cSlide * (sw + 16);
      s.style.transform = `translateX(-${o}px)`;
      const tg = s.querySelectorAll('.game-box').length;
      const mi = Math.max(0, tg - 4);
      document.getElementById('prevGames').style.display = cSlide > 0 ? 'flex' : 'none';
      document.getElementById('nextGames').style.display = cSlide < mi ? 'flex' : 'none';
    }

    document.getElementById('nextGames').addEventListener('click', () => { const s = document.getElementById('gamesSlider'); const tg = s.querySelectorAll('.game-box').length; const mi = Math.max(0, tg - 4); if (cSlide < mi) { cSlide++; uSlide(); } });
    document.getElementById('prevGames').addEventListener('click', () => { if (cSlide > 0) { cSlide--; uSlide(); } });

    document.getElementById('themeToggle').addEventListener('click', () => {
    const b = document.body;
    const logo = document.getElementById('logoImg');

    if (b.classList.contains('dark')) {
      // Switch to LIGHT mode
      b.classList.remove('dark');
      b.classList.add('light');
      document.getElementById('themeToggle').textContent = 'Dark';
      logo.src = 'assets/site-logos/logo-dark.svg';
    } else {
      // Switch to DARK mode
      b.classList.remove('light');
      b.classList.add('dark');
      document.getElementById('themeToggle').textContent = 'Light';
      logo.src = 'assets/site-logos/logo-light.svg';
    }

    // Re-render dependent UI
    uCharts();
    fGames();
    renderStandings();
    renderPredictions();
  });


    function rMetrics() {
      const mData = [
        { label: 'wRC+', value: '168', change: '+12' },
        { label: 'ISO', value: '.312', change: '+.045' },
        { label: 'BABIP', value: '.298', change: '-.015' },
        { label: 'K%', value: '23.1%', change: '-2.3%' },
        { label: 'BB%', value: '14.8%', change: '+1.9%' },
        { label: 'Hard%', value: '48.2%', change: '+5.1%' },
      ];
      const g = document.getElementById('metricsGrid');
      g.innerHTML = mData.map(m => `<div class="metric-item"><div class="metric-label">${m.label}</div><div class="metric-value">${m.value}</div><div class="metric-change ${m.change.startsWith('+') ? 'positive' : 'negative'}">${m.change}</div></div>`).join('');
    }

    function gCC() {
      const d = document.body.classList.contains('dark');
      return { text: d ? '#94a3b8' : '#64748b', grid: d ? '#1e293b' : '#e2e8f0' };
    }

    let pChart, prChart;

    function cPChart() {
      const ctx = document.getElementById('performanceChart').getContext('2d');
      const c = gCC();
      const isDark = document.body.classList.contains('dark');

      if (pChart) pChart.destroy();

      pChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep'],
          datasets: [
            {
              label: 'OPS',
              data: [0.845, 0.892, 0.901, 0.878, 0.915, 0.889],
              borderColor: '#bf0d3d',
              backgroundColor: '#bf0d3d',
              tension: 0.3,
              pointRadius: 3
            },
            {
              label: 'wOBA',
              data: [0.362, 0.381, 0.388, 0.375, 0.392, 0.379],
              borderColor: isDark ? '#ffffff' : '#041e41',
              backgroundColor: isDark ? '#ffffff' : '#041e41',
              tension: 0.3,
              pointRadius: 3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              labels: { font: { size: 11, family: 'Inter' }, color: c.text }
            }
          },
          scales: {
            x: { ticks: { font: { size: 11 }, color: c.text }, grid: { color: c.grid } },
            y: { ticks: { font: { size: 11 }, color: c.text }, grid: { color: c.grid } }
          }
        }
      });
    }

    function cPrChart() {
      const ctx = document.getElementById('projectionChart').getContext('2d');
      const c = gCC();
      const isDark = document.body.classList.contains('dark');

      if (prChart) prChart.destroy();

      prChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['2023', '2024', '2025', '2026'],
          datasets: [
            {
              label: 'Actual',
              data: [8.2, 7.9, null, null],
              backgroundColor: isDark ? '#ffffff' : '#041e41'
            },
            {
              label: 'Projected',
              data: [null, 7.8, 8.1, 7.6],
              backgroundColor: '#bf0d3d'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              labels: { font: { size: 11, family: 'Inter' }, color: c.text }
            }
          },
          scales: {
            x: { ticks: { font: { size: 11 }, color: c.text }, grid: { color: c.grid } },
            y: { ticks: { font: { size: 11 }, color: c.text }, grid: { color: c.grid } }
          }
        }
      });
    }

    function uCharts() { cPChart(); cPrChart(); }

    rCal();
    uDateText();
    fGames();
    fetchStandings();
    renderTopPerformers();
    renderPredictions();
    rMetrics();
    cPChart();
    cPrChart();

    setInterval(() => {
      const cd = fDate(cDate);
      const td = fDate(new Date());
      if (cd === td) fGames();
    }, 30000);
  </script>
</body>
</html>